<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>复古收音机 | 授权上传</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-lg shadow p-6">
    <!-- 返回按钮 -->
    <div class="mb-4 text-left">
      <button onclick="goBackHome()" class="text-blue-500 hover:text-blue-700 text-sm flex items-center">
        ← 返回收听主页
      </button>
    </div>

    <h1 class="text-xl font-bold text-center mb-6 text-gray-800">音乐上传中心</h1>
    
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">上传者昵称 <span class="text-red-500">*</span></label>
      <input type="text" id="nicknameInput" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="填写你的昵称">
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">GitHub 授权 Token（需 repo 全权限）<span class="text-red-500">*</span></label>
      <input type="password" id="tokenInput" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_xxxx...">
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">音乐标题 <span class="text-red-500">*</span></label>
      <input type="text" id="titleInput" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入音乐标题">
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">选择音乐文件（MP3/WAV，≤100MB）<span class="text-red-500">*</span></label>
      <input type="file" id="fileInput" accept="audio/mpeg,audio/wav" class="w-full px-3 py-2 border border-gray-300 rounded">
    </div>

    <button onclick="handleUpload()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">开始上传</button>
    <p id="statusText" class="mt-2 text-center text-sm text-gray-500"></p>
  </div>

  <script>
    // 固定私密仓库配置
    const CONFIG = {
      owner: "25eqsg3f08-stack",
      repo: "private-music-repo",
      dir: "music",
      branch: "main",
      maxSize: 100 * 1024 * 1024 // 100MB
    };

    // 返回主页函数
    function goBackHome() {
      window.location.href = "index.html";
    }

    // 处理文件上传
    async function handleUpload() {
      const nickname = document.getElementById("nicknameInput").value.trim();
      const token = document.getElementById("tokenInput").value.trim();
      const title = document.getElementById("titleInput").value.trim();
      const fileInput = document.getElementById("fileInput");
      const statusEl = document.getElementById("statusText");
      const file = fileInput.files[0];

      // 前置校验
      if (!nickname) return statusEl.textContent = "❌ 请填写上传者昵称";
      if (!token) return statusEl.textContent = "❌ 请输入授权 Token";
      if (!title) return statusEl.textContent = "❌ 请输入音乐标题";
      if (!file) return statusEl.textContent = "❌ 请选择音乐文件";
      if (file.size > CONFIG.maxSize) return statusEl.textContent = `❌ 文件超过 100MB 限制`;

      statusEl.textContent = "⏳ 处理中...（大文件可能较慢）";
      statusEl.className = "mt-2 text-center text-sm text-blue-500";

      try {
        // 读取文件为 Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = async () => {
          const base64Data = reader.result.split(",")[1];
          const fileExt = file.name.split(".").pop();
          const fileName = `${Date.now()}-${nickname.replace(/[^a-zA-Z0-9_\-\.]/g, "_")}-${title.replace(/[^a-zA-Z0-9_\-\.]/g, "_")}.${fileExt}`;
          const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.dir}/${fileName}?ref=${CONFIG.branch}`;

          try {
            const response = await fetch(apiUrl, {
              method: "PUT",
              mode: "cors", // 关键：启用跨域请求
              cache: "no-cache", // 禁用缓存
              headers: {
                "Authorization": `token ${token}`,
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                message: `[${nickname}] Upload music: ${title}`,
                content: base64Data,
                branch: CONFIG.branch
              })
            });

            const data = await response.json();
            if (response.ok) {
              statusEl.textContent = "✅ 上传成功！即将返回主页...";
              statusEl.className = "mt-2 text-center text-sm text-green-500";
              // 清空输入
              document.getElementById("nicknameInput").value = "";
              document.getElementById("tokenInput").value = "";
              document.getElementById("titleInput").value = "";
              fileInput.value = "";
              // 2秒后自动返回主页
              setTimeout(goBackHome, 2000);
            } else {
              // 详细错误提示
              const errMsg = data.message || "未知错误";
              const errDocs = data.documentation_url || "";
              throw new Error(`${errMsg} ${errDocs}`);
            }
          } catch (err) {
            statusEl.textContent = `❌ 上传失败: ${err.message}`;
            statusEl.className = "mt-2 text-center text-sm text-red-500";
          }
        };
      } catch (err) {
        statusEl.textContent = `❌ 系统错误: ${err.message}`;
        statusEl.className = "mt-2 text-center text-sm text-red-500";
      }
    }
  </script>
</body>
</html>
